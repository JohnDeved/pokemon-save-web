name: Copilot Environment Setup

on:
  workflow_call:
    inputs:
      node-version:
        description: 'Node.js version'
        required: false
        default: '20'
        type: string
      setup-docker:
        description: 'Whether to setup Docker'
        required: false
        default: true
        type: boolean
      install-playwright:
        description: 'Whether to install Playwright'
        required: false
        default: true
        type: boolean
  workflow_dispatch:
    inputs:
      node-version:
        description: 'Node.js version'
        required: false
        default: '20'
        type: string
      setup-docker:
        description: 'Whether to setup Docker'
        required: false
        default: true
        type: boolean
      install-playwright:
        description: 'Whether to install Playwright'
        required: false
        default: true
        type: boolean

jobs:
  copilot-setup-steps:
    name: Preinstall dependencies for Copilot environment
    runs-on: ubuntu-latest
    timeout-minutes: 50
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version || '20' }}
          cache: 'npm'
      
      - name: Install Node.js dependencies
        run: npm ci

      - name: Set up Docker Buildx
        if: ${{ inputs.setup-docker == true }}
        uses: docker/setup-buildx-action@v3

      - name: Install Lua and development tools
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: lua5.4 lua5.4-dev luarocks
          version: 1.0
      
      - name: Set up Lua alternatives
        run: |
          sudo update-alternatives --set lua-interpreter /usr/bin/lua5.4 2>/dev/null || true
          echo "Lua setup completed"

      - name: Cache Playwright browsers
        if: ${{ inputs.install-playwright == true }}
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-cache-v1-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-cache-v1-
      
      - name: Install Playwright
        if: ${{ inputs.install-playwright == true }}
        run: npx playwright install chromium --only-shell
      
      - name: Verify environment setup
        run: |
          echo "‚úÖ Node.js version: $(node --version)"
          echo "‚úÖ npm version: $(npm --version)"
          echo "‚úÖ Lua version: $(lua -v 2>&1 || echo 'Lua not available')"
          echo "‚úÖ Lua 5.4 version: $(lua5.4 -v 2>&1 || echo 'Lua 5.4 not available')"
          echo "‚úÖ Docker version: $(docker --version)"
          if [ "${{ inputs.install-playwright }}" == "true" ]; then
            echo "‚úÖ Playwright browsers installed"
          fi
          echo "‚úÖ Build tools available: $(gcc --version | head -1)"
          echo "‚úÖ Environment ready for npm run test:all"
          
      - name: Verify Lua integration capability 
        run: |
          echo "üåô Testing Lua integration capability..."
          lua -e "print('Lua integration test successful')" || echo "‚ö†Ô∏è Lua not configured"
          lua5.4 -e "print('Lua 5.4 integration test successful')" || echo "‚ö†Ô∏è Lua 5.4 not configured"